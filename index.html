<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Gesture Grid Controller</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f0f0;
        }
        
        .container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .webcam-container {
            flex: 1;
        }
        
        .grid-container {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .grid-cell {
            aspect-ratio: 1;
            border: none;
            background: #e0e0e0;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .grid-cell:hover {
            background: #d0d0d0;
        }
        
        .grid-cell:disabled {
            background: #b0b0b0;
            cursor: not-allowed;
        }
        
        #status {
            margin-top: 16px;
            padding: 12px;
            border-radius: 4px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .debug {
            margin-top: 16px;
            padding: 12px;
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .column-labels, .row-labels {
            display: flex;
            justify-content: space-around;
            margin: 8px;
        }
    </style>
</head>
<body>
    <h1>Hand Gesture Grid Controller</h1>
    
    <div class="container">
        <div class="webcam-container" id="webcam-container"></div>
        
        <div>
            <div class="column-labels">
                <span>A</span>
                <span>B</span>
                <span>C</span>
                <span>D</span>
                <span>E</span>
                <span>F</span>
            </div>
            
            <div class="grid-container" id="grid">
                <!-- Grid cells will be added dynamically -->
            </div>
            
            <div class="row-labels">
                <span>1-6</span>
            </div>
        </div>
    </div>
    
    <div id="status">Waiting for webcam...</div>
    <div class="debug" id="debug">Gesture tracking debug info will appear here</div>

    <script>
        let handLandmarker;
        let runningMode = "VIDEO";
        let webcamRunning = false;
        let lastValidGesture = '';
        let gestureTimeout = null;
        const gestureHoldTime = 1000; // Time in ms to hold gesture before triggering

        // Initialize the grid
        const grid = document.getElementById('grid');
        for (let i = 0; i < 6; i++) {
            for (let j = 0; j < 6; j++) {
                const button = document.createElement('button');
                button.className = 'grid-cell';
                button.setAttribute('data-position', `${i},${j}`);
                button.textContent = `${String.fromCharCode(65 + j)}${i + 1}`;
                grid.appendChild(button);
            }
        }

        // Initialize MediaPipe Hand Landmarker
        async function createHandLandmarker() {
            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
            );
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
                    delegate: "GPU"
                },
                runningMode: runningMode,
                numHands: 1
            });
        }

        // Initialize webcam
        async function initWebcam() {
            const video = document.createElement('video');
            video.style.transform = 'scaleX(-1)';
            
            const canvas = document.createElement('canvas');
            canvas.style.position = 'absolute';
            canvas.style.transform = 'scaleX(-1)';
            
            document.getElementById('webcam-container').appendChild(video);
            document.getElementById('webcam-container').appendChild(canvas);
            
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { width: 640, height: 480 },
                audio: false
            });
            
            video.srcObject = stream;
            video.play();
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            return { video, canvas };
        }

        // Analyze hand position to determine gesture
        function analyzeHandGesture(landmarks) {
            if (!landmarks || landmarks.length === 0) return null;
            
            // Extract key points (wrist and fingertips)
            const wrist = landmarks[0];
            const thumb = landmarks[4];
            const indexTip = landmarks[8];
            
            // Calculate basic vertical position relative to wrist
            const verticalDiff = indexTip.y - wrist.y;
            const horizontalDiff = indexTip.x - wrist.x;
            
            // Determine row (1-6) based on vertical position
            const row = Math.floor(indexTip.y * 6);
            
            // Determine column (A-F) based on horizontal position
            const col = Math.floor(indexTip.x * 6);
            
            return {
                row: Math.max(0, Math.min(5, row)),
                col: Math.max(0, Math.min(5, col))
            };
        }

        // Main prediction loop
        async function predictWebcam(video, canvas) {
            const ctx = canvas.getContext('2d');
            
            while (webcamRunning) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const startTimeMs = performance.now();
                const results = handLandmarker.detectForVideo(video, startTimeMs);
                
                if (results.landmarks && results.landmarks.length > 0) {
                    const gesture = analyzeHandGesture(results.landmarks[0]);
                    
                    if (gesture) {
                        const cellId = `${gesture.row},${gesture.col}`;
                        const button = document.querySelector(`[data-position="${cellId}"]`);
                        
                        if (button && !button.disabled) {
                            const gestureStr = `${String.fromCharCode(65 + gesture.col)}${gesture.row + 1}`;
                            
                            if (gestureStr !== lastValidGesture) {
                                if (gestureTimeout) clearTimeout(gestureTimeout);
                                
                                lastValidGesture = gestureStr;
                                document.getElementById('debug').textContent = `Detected gesture: ${gestureStr}`;
                                
                                gestureTimeout = setTimeout(() => {
                                    button.click();
                                    button.disabled = true;
                                    document.getElementById('status').textContent = `Selected: ${gestureStr}`;
                                }, gestureHoldTime);
                            }
                        }
                    }
                }
                
                // Draw landmarks
                if (results.landmarks) {
                    for (const landmarks of results.landmarks) {
                        drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {
                            color: '#00FF00',
                            lineWidth: 5
                        });
                        drawLandmarks(ctx, landmarks, {
                            color: '#FF0000',
                            lineWidth: 2
                        });
                    }
                }
                
                await new Promise(requestAnimationFrame);
            }
        }

        // Initialize everything
        async function init() {
            await createHandLandmarker();
            const { video, canvas } = await initWebcam();
            webcamRunning = true;
            document.getElementById('status').textContent = 'Ready! Move your hand to select grid positions';
            predictWebcam(video, canvas);
        }

        // Start the application
        init().catch(console.error);
    </script>
</body>
</html>
